#!/bin/bash

set -eu

vim_undopath() {
	echo "$HOME/.vim/undo/$(realpath "$1" | sed -e 's:/:%:g')"
}

mode= sha= subpath=
# Find entry not in stage
while read _mode _sha _stage _subpath ; do
	echo "$_mode,$_sha,$_stage,$_subpath" >&2
	if [ "$_stage" = "0" ]; then
		mode="$_mode"
		sha="$_sha"
		subpath="$_subpath"
		break
	fi
done <<< "$(git ls-files --stage -- "$1")"
echo "final: $mode,$sha,$subpath" >&2

mv -vn "$1" "$2"
mv -vi "$(vim_undopath "$1")" "$(vim_undopath "$2")"

subprefix="$(git rev-parse --show-prefix)"
git update-index --add --cacheinfo $mode,$sha,"$subprefix$2"
git rm --cached --force "$1"
